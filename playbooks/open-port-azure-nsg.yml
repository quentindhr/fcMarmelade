---
- name: Ouverture du port pour l'application sur Azure NSG
  hosts: localhost
  connection: local
  gather_facts: false

  collections:
    - azure.azcollection

  vars:
    # Resource Group (doit correspondre à create-public-vm-azure.yml)
    rg_name: Groupe5ResourceGroup
    rg_location: westeurope
    
    # Network Interface (doit correspondre à create-public-vm-azure.yml)
    nic_name: Groupe5NIC
    
    # Port à ouvrir
    app_port: 8080
    nsg_rule_name: "AllowHTTPPort{{ app_port }}"
    nsg_rule_priority: 1000

  tasks:
    # 1. Récupération du NSG associé à la Network Interface via Azure CLI
    - name: Récupération du NSG associé à la NIC
      command: >
        az network nic show
        --resource-group {{ rg_name }}
        --name {{ nic_name }}
        --query networkSecurityGroup.id
        --output tsv
      register: nsg_id_result
      failed_when: false
      changed_when: false

    # 2. Extraction du nom du NSG depuis l'ID
    - name: Extraction du nom du NSG
      set_fact:
        nsg_name: "{{ (nsg_id_result.stdout | default('')).split('/')[-1] if nsg_id_result.rc == 0 and nsg_id_result.stdout else (nic_name + '-nsg') }}"
        nsg_exists: "{{ nsg_id_result.rc == 0 and nsg_id_result.stdout | length > 0 }}"

    # 3. Création du NSG si absent
    - name: Création du NSG si absent
      azure_rm_securitygroup:
        resource_group: "{{ rg_name }}"
        name: "{{ nsg_name }}"
        location: "{{ rg_location }}"
      register: nsg_created
      when: not nsg_exists | bool

    # 4. Association du NSG à la NIC si nécessaire
    - name: Association du NSG à la Network Interface
      azure_rm_networkinterface:
        resource_group: "{{ rg_name }}"
        name: "{{ nic_name }}"
        network_security_group: "{{ nsg_name }}"
        state: present
      when: nsg_created is defined and nsg_created.changed

    # 6. Vérification si la règle existe déjà
    - name: Vérification de l'existence de la règle
      command: >
        az network nsg rule show
        --resource-group {{ rg_name }}
        --nsg-name {{ nsg_name }}
        --name {{ nsg_rule_name }}
      register: check_rule
      failed_when: false
      changed_when: false

    # 7. Ajout de la règle de sécurité pour le port de l'application
    - name: Ajout de la règle de sécurité pour le port {{ app_port }}
      command: >
        az network nsg rule create
        --resource-group {{ rg_name }}
        --nsg-name {{ nsg_name }}
        --name {{ nsg_rule_name }}
        --protocol Tcp
        --priority {{ nsg_rule_priority }}
        --direction Inbound
        --access Allow
        --source-address-prefixes "*"
        --source-port-ranges "*"
        --destination-address-prefixes "*"
        --destination-port-ranges {{ app_port }}
      when: check_rule.rc != 0
      register: nsg_rule_result

    # 8. Récupération de l'IP publique pour affichage
    - name: Récupération de l'IP publique
      azure_rm_publicipaddress_info:
        resource_group: "{{ rg_name }}"
        name: Groupe5PublicIP
      register: public_ip_info

    - name: Message de succès
      debug:
        msg: "✅ Le port {{ app_port }} est maintenant ouvert. L'application est accessible sur http://{{ public_ip_info.publicipaddresses[0].ip_address }}:{{ app_port }}"

