---
- name: Ouverture du port pour l'application sur Azure NSG
  hosts: localhost
  connection: local
  gather_facts: false

  collections:
    - azure.azcollection

  vars:
    # Resource Group (doit correspondre à create-public-vm-azure.yml)
    rg_name: Groupe5ResourceGroup
    rg_location: westeurope
    
    # Virtual Network / Subnet (doit correspondre à create-public-vm-azure.yml)
    vnet_name: Groupe5VNet
    subnet_name: Groupe5Subnet
    
    # Network Interface (doit correspondre à create-public-vm-azure.yml)
    nic_name: Groupe5NIC
    ipconfig_name: ipconfig1
    public_ip_name: Groupe5PublicIP
    
    # Port à ouvrir
    app_port: 8080
    nsg_name: "{{ nic_name }}-nsg"
    nsg_rule_name: "AllowHTTPPort{{ app_port }}"
    nsg_rule_priority: 1000

  tasks:
    # 1. Création ou mise à jour du NSG avec la règle pour le port {{ app_port }}
    - name: Création du NSG avec la règle pour le port {{ app_port }}
      azure_rm_securitygroup:
        resource_group: "{{ rg_name }}"
        name: "{{ nsg_name }}"
        location: "{{ rg_location }}"
        rules:
          - name: "{{ nsg_rule_name }}"
            protocol: Tcp
            source_port_range: "*"
            destination_port_range: "{{ app_port }}"
            source_address_prefix: "*"
            destination_address_prefix: "*"
            access: Allow
            priority: "{{ nsg_rule_priority }}"
            direction: Inbound
      register: nsg_result

    # 2. Association du NSG à la NIC
    - name: Association du NSG à la Network Interface
      azure_rm_networkinterface:
        resource_group: "{{ rg_name }}"
        name: "{{ nic_name }}"
        virtual_network: "{{ vnet_name }}"
        subnet_name: "{{ subnet_name }}"
        network_security_group: "{{ nsg_name }}"
        ip_configurations:
          - name: "{{ ipconfig_name }}"
            public_ip_address_name: "{{ public_ip_name }}"
            primary: true
        state: present

    # 3. Récupération de l'IP publique pour affichage
    - name: Récupération de l'IP publique
      azure_rm_publicipaddress_info:
        resource_group: "{{ rg_name }}"
        name: Groupe5PublicIP
      register: public_ip_info

    - name: Message de succès
      debug:
        msg: "✅ Le port {{ app_port }} est maintenant ouvert. L'application est accessible sur http://{{ public_ip_info.publicipaddresses[0].ip_address }}:{{ app_port }}"

