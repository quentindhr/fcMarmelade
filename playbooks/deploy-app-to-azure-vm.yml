---
- name: Installation et déploiement sur la VM Azure
  hosts: all
  become: true
  gather_facts: true

  collections:
    - community.docker

  vars:
    project_name: fcMarmelade
    project_dir: /opt/{{ project_name }}
    repository_url: https://github.com/quentindhr/fcMarmelade.git
    container_name: marmelade-shop
    container_image: marmelade-shop:latest
    container_port: 8080
    host_port: 8080

  tasks:
    # 1. Installation des dépendances système et Docker
    - name: Installation des dépendances système
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - git
          - python3-pip
        state: present
        update_cache: yes

    # 2. Configuration du dépôt Docker
    - name: Ajout de la clé GPG Docker
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
      args:
        creates: /usr/share/keyrings/docker-archive-keyring.gpg

    - name: Ajout du dépôt Docker
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        filename: docker

    # 3. Installation de Docker et du SDK Python
    - name: Installation de Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
        update_cache: yes

    - name: Installation du SDK Docker pour Python
      pip:
        name: docker
        state: present
        extra_args: --break-system-packages

    # 4. Configuration et démarrage de Docker
    - name: Démarrage et activation de Docker
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Ajout de l'utilisateur au groupe docker
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    # 5. Déploiement de l'application
    - name: Clonage du dépôt Git
      git:
        repo: "{{ repository_url }}"
        dest: "{{ project_dir }}"
        version: main
        force: yes

    # 6. Arrêt et suppression du conteneur existant
    - name: Arrêt et suppression du conteneur existant
      community.docker.docker_container:
        name: "{{ container_name }}"
        state: absent
      ignore_errors: true

    # 7. Build et déploiement du conteneur
    - name: Build de l'image Docker
      community.docker.docker_image:
        name: "{{ container_image }}"
        build:
          path: "{{ project_dir }}"
          dockerfile: Dockerfile
        source: build
        state: present
        force_source: yes

    - name: Création et démarrage du conteneur
      community.docker.docker_container:
        name: "{{ container_name }}"
        image: "{{ container_image }}"
        state: started
        restart_policy: unless-stopped
        ports:
          - "{{ host_port }}:{{ container_port }}"
        labels:
          com.marmelade.description: "Site web de vente de marmelades"
          com.marmelade.version: "1.0"

    # 8. Message de succès
    - name: Message de succès
      debug:
        msg: "✅ L'application est déployée et accessible sur http://{{ ansible_host }}:{{ host_port }}"

